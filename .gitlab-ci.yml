image: node:16-alpine

stages:
 - build
 - deploy

build_code:
 stage: build
 only:
 - main
 - testing
 tags:
 - testing
 allow_failure: true
 script:
 - echo build stage
 - apk update && apk add git && apk add openssh-client
 - npm config set registry https://registry.npm.taobao.org
 - npm install pnpm -g
 - pnpm install
 - pnpm run build
 - scp ./dist/** root@192.168.10.99:/root/gitlab_ci_deploy
 - echo build success


build_image:
 stage: build
 needs:
 - build_code
 only:
 - main
 - testing
 tags:
 - testing
 script:
 - echo build image stage

deploy:
 stage: deploy
 needs:
 - build_image
 tags:
 - testing
 only:
 - main
 - testing
 script:
 - echo deploy stage
